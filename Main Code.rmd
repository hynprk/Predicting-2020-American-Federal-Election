---
title: "Predicting 2020 American Federal Election"
author: "Pamela De Vera, Hyoeun Park"
date: "11/02/2020"
output: pdf_document
---
```{r, echo=FALSE, message=FALSE}
# This is where all the main codes go

################################################################################

# Install any of the packages below if uninstalled:
## install.packages("tidyverse")
## install.packages("lme4")
## install.packages("arm")
## install.packages("knitr")
## install.packages("kableExtra")
## install.packages("readr")

# Libraries
library(tidyverse)
library(lme4)
library(arm)
library(knitr)
library(readr)
library(kableExtra)

# Set working directory
## You may want to change this if you wish
setwd("~/Desktop/STA304/Problem Set 3/election_data")

# Loading in the cleaned survey Data
survey_data <- read_csv("~/outputs/survey_data.csv")

# Loading in the cleaned census Data
census_data <- read_csv("~/outputs/census_data.csv")

################################################################################

# Model
# Frequentist Multilevel Logistic Regression Model
## Random Intercept Model for Biden
pollmodel_Biden <- glmer(as.factor(vote_biden) ~ sex + age_group + 
race + is_hispanic + education_level + 
income_class + (1 | region), 
family = binomial, 
data = survey_data)

## Random Intercept Model for Trump
pollmodel_Trump <- glmer(as.factor(vote_trump) ~ sex + age_group + 
race + is_hispanic + education_level + 
income_class + (1 | region), 
family = binomial, 
data = survey_data)

# See regression output for Biden
summary(pollmodel_Biden)
ranef(pollmodel_Biden) # Coefficients of slope $\beta_{0j}$

# See regression output for Trump
summary(pollmodel_Trump)
ranef(pollmodel_Trump)

# Diagnostics
## Binned Residual Plot for Biden
binnedplot(fitted(pollmodel_Biden), 
           residuals(pollmodel_Biden, type = "response"), 
           xlab = "Expected Values", 
           ylab = "Average residual", 
           main = "Biden: Binned Residual Plot",
           sub = "Figure 1")

## Binned Residual Plot for Trump
binnedplot(fitted(pollmodel_Trump), 
           residuals(pollmodel_Trump, type = "response"), 
           xlab = "Expected Values", 
           ylab = "Average residual", 
           main = "Trump: Binned Residual Plot",
           sub = "Figure 2")

################################################################################

# Table of Regression Outputs of the Model
## See coefficient estimates for each variable
estimates <- coef(poll_model)[1]

## Creating data frame for table
regoutput <- tibble(coefficients = c("Intercept ($\\hat{r_{00}}$)", "Northwest", "Midwest", "South", "West", 
"26-35", "36-45", "46-55", "56-65", "66-75", "76-85", "86-95", 
"Male", 
"Black", "Indigenous", "Other", "White", 
"Hispanic", 
"Master/Doctorate", "Primary/Secondary", 
"Low Income", "Middle Income"), 
estimates = c(1.1771, 0.1307, 0.05331, -0.2650, 0.0810, 
-0.4538, -0.5776, -0.8187, -0.5443, -0.4893, -0.7497, -0.9717, 
-0.4107, 
1.3902, -0.9658, -0.2644, -0.7944, 
0.3786, 
0.0305, -0.3163, 
0.4211, 0.2911))


## Create Table 1
table1 <- kable(regoutput, caption = "Model Summary", 
col.names = c("Coefficients", "Estimates"), 
format = 'latex', escape = FALSE) %>% 
pack_rows("Intercept", 1, 5) %>% 
pack_rows("Age Group", 6, 12) %>% 
pack_rows("Sex", 13, 13) %>% 
pack_rows("Race", 14, 17) %>% 
pack_rows("Hispanic", 18, 18) %>% 
pack_rows("Education Level", 19, 20) %>% 
pack_rows("Income Level", 21, 22) %>% 
row_spec(0, bold = TRUE) %>% 
kable_classic_2(full_width = F)

## See Table 1
table1

################################################################################

# Post-stratification Calculation: Biden

## Create a variable in the dataset for the log odds based on our model
census_data$logestimate_Biden <-
  pollmodel_Biden %>%
  predict(newdata = census_data)

## Create a variable in the dataset with the probabiity estimate that a cell will
## vote for Biden
census_data$estimate_Biden <-
  exp(census_data$logestimate_Biden)/(1+exp(census_data$logestimate_Biden))

## Post stratification calculation
census_data$prop_Biden <-
  census_data$estimate_Biden*census_data$n

## See post-stratification result
## yhat_Biden := proportion of Americans voting for Joe Biden
yhat_Biden = sum(census_data$prop_Biden)/sum(census_data$n)



# Post-stratification Calculation: Trump

## Create a variable in the dataset for the log odds based on our model
census_data$logestimate_Trump <-
  pollmodel_Trump %>%
  predict(newdata = census_data)

## Create a variable in the dataset with the probabiity estimate that a cell will
## vote for Trump
census_data$estimate_Trump <-
  exp(census_data$logestimate_Trump)/(1+exp(census_data$logestimate_Trump))

## Post stratification calculation
census_data$prop_Trump <-
  census_data$estimate_Trump*census_data$n

## See post-stratification result
## yhat_Trump := proportion of Americans voting for Donald Trump
yhat_Trump = sum(census_data$prop_Trump)/sum(census_data$n)

```
