---
title: "Predicting 2020 American Federal Election"
author: "Pamela De Vera, Hyoeun Park"
date: "11/02/2020"
output: pdf_document
---
```{r, echo=FALSE, message=FALSE}
# This is where all the main codes go

################################################################################

# Install any of the packages below if uninstalled:
## install.packages("tidyverse")
## install.packages("lme4")
## install.packages("arm")
## install.packages("knitr")
## install.packages("kableExtra")
## install.packages("readr")

# Libraries
library(tidyverse)
library(lme4)
library(arm)
library(knitr)
library(readr)
library(kableExtra)

# Set working directory
## You may want to change this if you wish
setwd("~/Desktop/STA304/Problem Set 3/election_data")

# Loading in the cleaned survey Data
survey_data <- read_csv("~/outputs/survey_data.csv")

# Loading in the cleaned census Data
census_data <- read_csv("~/outputs/census_data.csv")

################################################################################

# Model
# Frequentist Multilevel Logistic Regression Model
## Random Intercept Model for Biden
pollmodel_Biden <- glmer(as.factor(vote_biden) ~ sex + age_group + 
race + is_hispanic + education_level + 
income_class + (1 | region), 
family = binomial, 
data = survey_data)

## Random Intercept Model for Trump
pollmodel_Trump <- glmer(as.factor(vote_trump) ~ sex + age_group + 
race + is_hispanic + education_level + 
income_class + (1 | region), 
family = binomial, 
data = survey_data)

# See regression output for Biden
summary(pollmodel_Biden)
ranef(pollmodel_Biden) # Coefficients of slope $\beta_{0j}$

# See regression output for Trump
summary(pollmodel_Trump)
ranef(pollmodel_Trump)

################################################################################

# Diagnostics
## Binned Residual Plot for Biden
binnedplot(fitted(pollmodel_Biden), 
           residuals(pollmodel_Biden, type = "response"), 
           xlab = "Expected Values", 
           ylab = "Average residual", 
           main = "Biden: Binned Residual Plot",
           sub = "Figure 1")

## Binned Residual Plot for Trump
binnedplot(fitted(pollmodel_Trump), 
           residuals(pollmodel_Trump, type = "response"), 
           xlab = "Expected Values", 
           ylab = "Average residual", 
           main = "Trump: Binned Residual Plot",
           sub = "Figure 2")

################################################################################

# Table of Regression Outputs of Both Models

regoutput <- tibble(coefficients = c("Intercept", "Northwest", "Midwest", "South", "West", 
"26-35", "36-45", "46-55", "56-65", "66-75", "76-85", "86-95", 
"Male", "Black", "Indigenous", "Other", "White", "Hispanic", 
"Master/Doctorate", "Primary/Secondary", "Low Income", "Middle Income"), 
b_estimates = c(0.5903, 0.0765, 0.0547, -0.2037, 0.0728, 
-0.2000, -0.2318, -0.4453, -0.0936, -0.0553, -0.2780, -0.4227, 
-0.3860, 0.8694, -0.9078, -0.2828, -0.5913, 0.3126, 
0.0220, -0.3703, 0.2208, 0.2150), 
b_pval = c("0.0009", "", "", "", "", 
"2.47x10^(-11)", "0.0552", "0.0264", "7.13x10^(-5)", "0.3908", "0.6363", "0.1641", 
"0.5569", "3.12x10^(-8)", "0.0011", "0.1065", "6.91x10^(-6)", "0.0007", 
"0.8106", "9.97x10^(-9)", "0.0191", "0.0158"), 
t_estimates = c(-1.2716, -0.1349, -0.0443, 0.2498, -0.0700, 0.4385, 
0.5912, 0.7978, 0.6799, 0.6310, 0.9061, 1.2800, 
0.3696, -1.3115, 0.7120, 0.2067, 0.7844, -0.3037, 
0.0048, 0.1986, -0.5630, -0.3442), 
t_pval = c("9.96x10^(-11)", "", "", "", "", 
"5.36x10^(-10)", "0.0002", "2.52x10^(-7)", "4.43x10^(-11)", "9.25x10^(-9)", "5.36x10^(-7)", "8.41x10^(-6)", 
"0.0741", "9.98x10^(-12)", "0.0104", "0.2843", "4.99x10^(-8)", "0.0018", 
"0.9594", "0.0029", "4.42x10^(-9)", "0.0001"))

table1 <- kable(regoutput, caption = "Model Summary", 
col.names = c("Coefficients", "Estimates", "P-values", "Estimates", "P-values")) %>% 
pack_rows("Intercept: Region", 1, 5) %>% 
pack_rows("Age Group", 6, 12) %>% 
pack_rows("Sex", 13, 13) %>% 
pack_rows("Race", 14, 17) %>% 
pack_rows("Hispanic", 18, 18) %>% 
pack_rows("Education Level", 19, 20) %>% 
pack_rows("Income Level", 21, 22) %>% 
row_spec(0, bold = TRUE) %>% 
kable_classic_2(full_width = F) %>% 
add_header_above(c(" " = 1, "Joe Biden" = 2, "Donald Trump" = 2))

## See Table 1
table1
################################################################################

# Post-stratification Calculation: Biden

## Create a variable in the dataset for the log odds based on our model
census_data$logestimate_Biden <-
  pollmodel_Biden %>%
  predict(newdata = census_data)

## Create a variable in the dataset with the probabiity estimate that a cell will
## vote for Biden
census_data$estimate_Biden <-
  exp(census_data$logestimate_Biden)/(1+exp(census_data$logestimate_Biden))

## Post stratification calculation
census_data$prop_Biden <-
  census_data$estimate_Biden*census_data$n

## See post-stratification result
## yhat_Biden := proportion of Americans voting for Joe Biden
yhat_Biden <- sum(census_data$prop_Biden)/sum(census_data$n)



# Post-stratification Calculation: Trump

## Create a variable in the dataset for the log odds based on our model
census_data$logestimate_Trump <-
  pollmodel_Trump %>%
  predict(newdata = census_data)

## Create a variable in the dataset with the probabiity estimate that a cell will
## vote for Trump
census_data$estimate_Trump <-
  exp(census_data$logestimate_Trump)/(1+exp(census_data$logestimate_Trump))

## Post stratification calculation
census_data$prop_Trump <-
  census_data$estimate_Trump*census_data$n

## See post-stratification result
## yhat_Trump := proportion of Americans voting for Donald Trump
yhat_Trump <- sum(census_data$prop_Trump)/sum(census_data$n)

```
